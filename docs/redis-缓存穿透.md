## 概述

**缓存穿透**是指请求的数据既不在缓存中，也不在数据库中。这种情况会导致缓存直接“穿透”并访问数据库，极大增加数据库的压力。

### 实现

防御缓存穿透常用手段：布隆过滤器→空值缓存→熔断降级

使用布隆过滤器拦截非法key

动态空值缓存应对穿透漏网之鱼

数据库保护机制触发熔断

#### 布隆过滤器

 **布隆过滤器（Bloom Filter）**是一种非常高效的空间节省的数据结构，通常用于检测某个元素是否存在于一个集合中。它的特点是能用极少的内存存储大量数据，并且能够在常数时间内进行查询，但它也有一个缺点：可能会误判（即认为某个元素存在，但实际上并不存在），但绝对不会漏判（即认为某个元素不存在，但实际上存在）。

布隆过滤器可以用于防止缓存穿透，提前在布隆过滤器中判断某个数据是否存在。如果不存在，则直接返回空值，避免查询数据库。

**构建布隆过滤器**：

- 在系统中维护一个布隆过滤器，用于保存所有可能存在于数据库中的有效数据的标识符（如ID、用户名、商品编号等）。
- 在系统初始化时，将所有有效的数据标识符批量插入到布隆过滤器中。

**请求处理流程**：

- 当客户端发起请求时，首先检查布隆过滤器中是否存在该数据。
- 如果布隆过滤器判定数据**不存在**，则直接返回空值或者错误信息，避免无效查询。
- 如果布隆过滤器判定数据，可能存在则接下来查询缓存。
  - 如果缓存中存在数据，直接返回缓存数据。
  - 如果缓存中没有数据，再查询数据库并将查询结果缓存起来。

预存所有合法key的指纹，拦截明显非法请求

#### 缓存空值

当查询某些不存在的数据时，可以将其**空值**（例如：`"empty"`、`null`或一个特定标记）缓存起来，并为其设置TTL，防止频繁查询数据库。

设计合理的缓存Key，使得缓存数据只与有效的数据标识符相关，避免出现不必要的缓存键值冲突和空查询的情况。

#### 数据库保护机制

**数据库熔点机制**（也称为**断路器模式**）主要是为了应对数据库的高并发请求，防止因数据库负载过高而导致系统崩溃。熔点机制的核心思想是当数据库出现故障或者性能过载时，停止请求进一步访问数据库，转而提供备用的返回结果或降级处理，直到数据库恢复正常。

**熔点机制的基本设计**：

1. **断路器（Circuit Breaker）状态**：
   - **闭合状态（Closed）**：所有请求正常进行，访问数据库。
   - **打开状态（Open）**：数据库访问出现问题，暂时停止所有数据库请求，返回默认数据或降级结果。
   - **半开状态（Half-Open）**：经过一定时间的休眠或间隔后，尝试少量请求访问数据库。如果数据库恢复正常，断路器切换回闭合状态，否则保持打开状态。
2. **设计思路**：
   - 设置一个**错误阈值**（比如连续的数据库查询失败次数），一旦超过该阈值，切换到**打开状态**。
   - 在**打开状态**下，所有的请求都会被拦截，不再访问数据库，而是返回备用的降级数据或缓存数据。
   - 定期**检查数据库的健康状态**，当数据库恢复正常时，切换回**半开状态**，允许一小部分请求访问数据库以判断数据库是否完全恢复。如果恢复正常，切换回**闭合状态**。

### **结语**

真正的系统高可用，靠的不是某个银弹，而是层层防御的艺术。